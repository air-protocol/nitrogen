const BJSON = require('buffer-json')
const { buildAgreement } = require('../../src/consumer/agreement')
const proposalsJson = '[["cde1234",{"uuid":"96ec4f9f-d458-4149-9457-73259024e481","publicKey":{"type":"Buffer","data":"base64:BLDp52+WPRZzDtmc+zJl9xVUXKiR6Uu9vO7jSV24SXYHnHk0xzBBagp6gBuK5rqpeO1HR9HbJ5oA41s3s9wcarY="},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","offerAsset":"native","offerAmount":200,"requestAsset":"peanuts","requestAmount":100,"conditions":[],"juryPool":"ghi1234","challengeStake":5,"audience":[]},"hash":{"type":"Buffer","data":"base64:qXl/ueIQVYXWGKZqrTDaKTsZfo/Du9WrfFPpcwfjSg0="},"signature":{"type":"Buffer","data":"base64:MEUCIQCBDgZdSj0VIuBAaS8M/ki5Ktbf7zpFSGtzQoT7WtvxvQIgKKupASQXIJf3SbiaIN1HrFAYfazHsdORnYMeBEkt7O0="},"counterOffers":[{"uuid":"67dcc5d7-0fb5-480e-a2a1-2d520ee62e5a","publicKey":{"type":"Buffer","data":"base64:BFul985mCDhmF7hORtevT7JOY7utCyapAogijCeJtYy0n2LAlut2AK2VS9D3sVcRbJiXle2zoV9R9CihZ8sWOR4="},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","offerAsset":"native","offerAmount":200,"requestAsset":"peanuts","requestAmount":80,"conditions":[],"juryPool":"ghi1234","challengeStake":5,"audience":[],"takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","message":"countered","previousHash":{"type":"Buffer","data":"base64:qXl/ueIQVYXWGKZqrTDaKTsZfo/Du9WrfFPpcwfjSg0="}},"recipientKey":{"type":"Buffer","data":"base64:BLDp52+WPRZzDtmc+zJl9xVUXKiR6Uu9vO7jSV24SXYHnHk0xzBBagp6gBuK5rqpeO1HR9HbJ5oA41s3s9wcarY="},"hash":{"type":"Buffer","data":"base64:Bl3QefyzmkER71XIF91iwwhHKfjlqqYV2n3AAng1wMg="},"signature":{"type":"Buffer","data":"base64:MEUCIQDthcUjXbJdE8fp/ojgqZcyfcO24z8SaqkD/KRV5iNaPQIgct5AYtmoaO1h6uKtppWJam7ZR+Bo9+AwRD2cNHlxDRA="}},{"uuid":"e5b9e848-a1d5-4a20-9a48-72392262a02e","publicKey":{"type":"Buffer","data":"base64:BLDp52+WPRZzDtmc+zJl9xVUXKiR6Uu9vO7jSV24SXYHnHk0xzBBagp6gBuK5rqpeO1HR9HbJ5oA41s3s9wcarY="},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","offerAsset":"native","offerAmount":200,"requestAsset":"peanuts","requestAmount":95,"conditions":[],"juryPool":"ghi1234","challengeStake":5,"audience":[],"takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","message":"countered","previousHash":{"type":"Buffer","data":"base64:Bl3QefyzmkER71XIF91iwwhHKfjlqqYV2n3AAng1wMg="}},"recipientKey":{"type":"Buffer","data":"base64:BFul985mCDhmF7hORtevT7JOY7utCyapAogijCeJtYy0n2LAlut2AK2VS9D3sVcRbJiXle2zoV9R9CihZ8sWOR4="},"hash":{"type":"Buffer","data":"base64:H7lD3wyEUS5sjAg25iAPe8Zf3dqFVPfrWszwq+xiC6E="},"signature":{"type":"Buffer","data":"base64:MEUCIQDfEseaYFCzkB9O8XpM7QlJKyWHkVqFBbM0fG94sS21PAIgWv0EdN9Z88Uohps2VLvlxLP0CPrCOulyOLw0/ftZb+4="}}],"acceptances":[{"uuid":"06fac89b-e57c-4b9f-8815-767a41d99666","publicKey":{"type":"Buffer","data":"base64:BFul985mCDhmF7hORtevT7JOY7utCyapAogijCeJtYy0n2LAlut2AK2VS9D3sVcRbJiXle2zoV9R9CihZ8sWOR4="},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","offerAsset":"native","offerAmount":200,"requestAsset":"peanuts","requestAmount":95,"conditions":[],"juryPool":"ghi1234","challengeStake":5,"audience":[],"takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","message":"accepted","previousHash":{"type":"Buffer","data":"base64:H7lD3wyEUS5sjAg25iAPe8Zf3dqFVPfrWszwq+xiC6E="}},"recipientKey":{"type":"Buffer","data":"base64:BLDp52+WPRZzDtmc+zJl9xVUXKiR6Uu9vO7jSV24SXYHnHk0xzBBagp6gBuK5rqpeO1HR9HbJ5oA41s3s9wcarY="},"hash":{"type":"Buffer","data":"base64:QEzqyO3sWqurWNrbhXB39LsA5d/xswDNHKhkZdw2DsM="},"signature":{"type":"Buffer","data":"base64:MEUCIQCaeYUWyCHBMk+HMtYNAMXCloWHZgrDG3SruywgjeSucgIgbGcRRIIQtvd5yvl4xInMSDWk1BWdqJ8OSFCHTkyHn6Q="}}],"fulfillments":[{"uuid":"a0a5dd1d-386a-4613-993f-03492c69f9a2","publicKey":{"type":"Buffer","data":"base64:BFul985mCDhmF7hORtevT7JOY7utCyapAogijCeJtYy0n2LAlut2AK2VS9D3sVcRbJiXle2zoV9R9CihZ8sWOR4="},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","message":"fulfillment","fulfillment":"account transfer","previousHash":{"type":"Buffer","data":"base64:QEzqyO3sWqurWNrbhXB39LsA5d/xswDNHKhkZdw2DsM="}},"recipientKey":{"type":"Buffer","data":"base64:BLDp52+WPRZzDtmc+zJl9xVUXKiR6Uu9vO7jSV24SXYHnHk0xzBBagp6gBuK5rqpeO1HR9HbJ5oA41s3s9wcarY="},"hash":{"type":"Buffer","data":"base64:Q98ZFzrSuygJ+tHBvFXH60EnfIy+aZgkewjL4JH5CR0="},"signature":{"type":"Buffer","data":"base64:MEUCIQDFHPDVAeDVnm4/t69ivWs8R7L7VUTNXbkwfjcKsJbLYwIgYkwsQJPcKEg8GjPmZJVKmnFvz9dfC5JwyUr04UAFh0I="}}],"resolution":{"uuid":"f7f6600f-4fb6-4ded-8a19-f3f44168d388","publicKey":{"type":"Buffer","data":"base64:BLDp52+WPRZzDtmc+zJl9xVUXKiR6Uu9vO7jSV24SXYHnHk0xzBBagp6gBuK5rqpeO1HR9HbJ5oA41s3s9wcarY="},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","message":"resolved","previousHash":{"type":"Buffer","data":"base64:qXl/ueIQVYXWGKZqrTDaKTsZfo/Du9WrfFPpcwfjSg0="}},"hash":{"type":"Buffer","data":"base64:JOSJrht6YbQnGjg3c9nrbIBmac2qfFIJ3DE9jjDoLM4="},"signature":{"type":"Buffer","data":"base64:MEUCIQCZnUSpTngXIvM4iLLCjquZTGocf2jRLpd1vgb65Nn2kgIgJu2mZKGTIy6X7yFGwqeCluXyjr/xd4cPi7miKbRDDgM="}},"settlementInitiated":{"uuid":"e3c4690d-fe8b-412f-94b8-055e6db314ae","publicKey":{"type":"Buffer","data":"base64:BLDp52+WPRZzDtmc+zJl9xVUXKiR6Uu9vO7jSV24SXYHnHk0xzBBagp6gBuK5rqpeO1HR9HbJ5oA41s3s9wcarY="},"body":{"makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","requestId":"cde1234","message":"settlementInitiated","escrow":"GA6Q4SHIQ2GXZGXZV2JRLM4EW3I36WU2OC3KD4Z634FW7TL6E75655RF","previousHash":{"type":"Buffer","data":"base64:QEzqyO3sWqurWNrbhXB39LsA5d/xswDNHKhkZdw2DsM="}},"recipientKey":{"type":"Buffer","data":"base64:BFul985mCDhmF7hORtevT7JOY7utCyapAogijCeJtYy0n2LAlut2AK2VS9D3sVcRbJiXle2zoV9R9CihZ8sWOR4="},"hash":{"type":"Buffer","data":"base64:Z+8+XHRDJQkkNuEF02dhvG8B511meUifwF/98Ve682M="},"signature":{"type":"Buffer","data":"base64:MEUCIQDUG5rOcgw834NfFsEm5w2Mu0pWRpzyrusuEIHnViz6JgIgVRnr664sEQPuWwUs4WjRUboQFeuUaBm6HzA6IJTa2ik="}},"signatureRequired":{"uuid":"9a282785-d6dc-4d70-b030-79e750429630","publicKey":{"type":"Buffer","data":"base64:BLDp52+WPRZzDtmc+zJl9xVUXKiR6Uu9vO7jSV24SXYHnHk0xzBBagp6gBuK5rqpeO1HR9HbJ5oA41s3s9wcarY="},"body":{"makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","requestId":"cde1234","message":"signatureRequired","transaction":"AAAAAD0OSOiGjXya+a6TFbOEttG/WppwtqHzPt8Lb81+J/vuAAAAyAAUUVEAAAACAAAAAAAAAAAAAAACAAAAAAAAAAEAAAAAYo4h6Lq9uidCXGzXtEYZObEB6M9DurLG2zg4Itl8YAMAAAAAAAAAAHc1lAAAAAAAAAAACAAAAAAYJf2teKEI0fmZRSwam/E+esu7RaxyvOw49ePdCSKUxgAAAAAAAAABCSKUxgAAAED1VyTjDxF1og/7ZDUd3rzNKqR4QIvcyFSDLJQR6H2xlcNFYQPlCd11bk3cN5gC0IH+eshOf3dklhOcUDTlwskP","previousHash":{"type":"Buffer","data":"base64:QEzqyO3sWqurWNrbhXB39LsA5d/xswDNHKhkZdw2DsM="}},"recipientKey":{"type":"Buffer","data":"base64:BFul985mCDhmF7hORtevT7JOY7utCyapAogijCeJtYy0n2LAlut2AK2VS9D3sVcRbJiXle2zoV9R9CihZ8sWOR4="},"hash":{"type":"Buffer","data":"base64:2mWUVdd/sVmkneHgS7THRNQxnaXpLgAIXHnr0g1+EjQ="},"signature":{"type":"Buffer","data":"base64:MEUCIQD2eKNxAXwlODKPl4IFkb1boJgU9tMRcd/PJExkmBlt8AIgdJCwFVSVyZpIQSgP6/Cn3uA42ojSr1kMy33LKyC8s58="}}}]]'

const proposals = new Map(BJSON.parse(proposalsJson))

test('build agreement does', () => {
    //Assemble

    //Action
    const agreement = buildAgreement(proposals.get('cde1234'))

    //Assert
    expect(agreement.publicKey.toString('hex')).toEqual('04b0e9e76f963d16730ed99cfb3265f715545ca891e94bbdbceee3495db84976079c7934c730416a0a7a801b8ae6baa978ed4747d1db279a00e35b37b3dc1c6ab6')
    expect(agreement.body.message).toEqual('proposal')
    expect(agreement.body.makerId).toEqual('GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3')
    expect(agreement.body.offerAsset).toEqual('native')
    expect(agreement.body.offerAmount).toEqual(200)
    expect(agreement.body.requestAsset).toEqual('peanuts')
    expect(agreement.body.requestAmount).toEqual(100)

    const firstCounterOffer = agreement.next
    expect(firstCounterOffer.publicKey.toString('hex')).toEqual('045ba5f7ce6608386617b84e46d7af4fb24e63bbad0b26a90288228c2789b58cb49f62c096eb7600ad954bd0f7b157116c989795edb3a15f51f428a167cb16391e')
    expect(firstCounterOffer.body.message).toEqual('countered')
    expect(firstCounterOffer.body.makerId).toEqual('GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3')
    expect(firstCounterOffer.body.takerId).toEqual('GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV')
    expect(firstCounterOffer.body.offerAsset).toEqual('native')
    expect(firstCounterOffer.body.offerAmount).toEqual(200)
    expect(firstCounterOffer.body.requestAsset).toEqual('peanuts')
    expect(firstCounterOffer.body.requestAmount).toEqual(80)

    const secondCounterOffer = agreement.next.next
    expect(secondCounterOffer.publicKey.toString('hex')).toEqual('04b0e9e76f963d16730ed99cfb3265f715545ca891e94bbdbceee3495db84976079c7934c730416a0a7a801b8ae6baa978ed4747d1db279a00e35b37b3dc1c6ab6')
    expect(secondCounterOffer.body.message).toEqual('countered')
    expect(secondCounterOffer.body.makerId).toEqual('GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3')
    expect(secondCounterOffer.body.takerId).toEqual('GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV')
    expect(secondCounterOffer.body.offerAsset).toEqual('native')
    expect(secondCounterOffer.body.offerAmount).toEqual(200)
    expect(secondCounterOffer.body.requestAsset).toEqual('peanuts')
    expect(secondCounterOffer.body.requestAmount).toEqual(95)

    const acceptance = agreement.next.next.next
    expect(acceptance.publicKey.toString('hex')).toEqual('045ba5f7ce6608386617b84e46d7af4fb24e63bbad0b26a90288228c2789b58cb49f62c096eb7600ad954bd0f7b157116c989795edb3a15f51f428a167cb16391e')
    expect(acceptance.body.message).toEqual('accepted')
    expect(acceptance.body.makerId).toEqual('GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3')
    expect(acceptance.body.takerId).toEqual('GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV')
    expect(acceptance.body.offerAsset).toEqual('native')
    expect(acceptance.body.offerAmount).toEqual(200)
    expect(acceptance.body.requestAsset).toEqual('peanuts')
    expect(acceptance.body.requestAmount).toEqual(95)
})