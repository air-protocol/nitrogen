const { buildAgreement } = require('../../src/consumer/agreement')
const proposalsJson = '[["cde1234",{"uuid":"05076eb7-b94f-4529-8f83-d6f1d019ce68","publicKey":{"type":"Buffer","data":[4,60,173,198,187,52,232,6,51,60,89,161,120,251,71,239,156,72,43,216,110,237,221,186,15,83,113,177,110,38,204,210,147,137,127,109,164,220,28,18,43,130,245,19,38,119,175,62,120,61,77,33,209,198,135,12,243,193,190,42,76,65,88,219,73]},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","offerAsset":"native","offerAmount":200,"requestAsset":"peanuts","requestAmount":100,"conditions":[],"juryPool":"ghi1234","challengeStake":5,"audience":[]},"hash":{"type":"Buffer","data":[169,121,127,185,226,16,85,133,214,24,166,106,173,48,218,41,59,25,126,143,195,187,213,171,124,83,233,115,7,227,74,13]},"signature":{"type":"Buffer","data":[48,69,2,33,0,141,183,255,53,211,107,54,207,6,128,236,53,47,89,241,43,39,255,131,156,85,52,94,182,116,62,199,251,62,143,188,194,2,32,31,180,62,179,243,3,90,144,209,197,68,246,167,250,10,133,132,232,194,158,176,66,249,97,19,80,8,12,109,226,202,18]},"counterOffers":[{"uuid":"6e00be98-14f4-4c14-9ef1-e47116010a53","publicKey":{"type":"Buffer","data":[4,125,163,195,169,239,252,211,66,233,105,52,198,59,236,234,24,82,197,194,41,111,204,250,254,178,0,134,47,251,156,223,44,164,5,175,57,189,6,239,17,130,125,226,38,233,166,209,74,188,142,194,230,230,225,98,65,29,132,211,67,97,168,139,216]},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","offerAsset":"native","offerAmount":200,"requestAsset":"peanuts","requestAmount":80,"conditions":[],"juryPool":"ghi1234","challengeStake":5,"audience":[],"takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","message":"countered","previousHash":{"type":"Buffer","data":[169,121,127,185,226,16,85,133,214,24,166,106,173,48,218,41,59,25,126,143,195,187,213,171,124,83,233,115,7,227,74,13]}},"recipientKey":{"type":"Buffer","data":[4,60,173,198,187,52,232,6,51,60,89,161,120,251,71,239,156,72,43,216,110,237,221,186,15,83,113,177,110,38,204,210,147,137,127,109,164,220,28,18,43,130,245,19,38,119,175,62,120,61,77,33,209,198,135,12,243,193,190,42,76,65,88,219,73]},"hash":{"type":"Buffer","data":[6,93,208,121,252,179,154,65,17,239,85,200,23,221,98,195,8,71,41,248,229,170,166,21,218,125,192,2,120,53,192,200]},"signature":{"type":"Buffer","data":[48,69,2,33,0,171,73,145,64,81,42,54,98,20,211,68,11,181,71,243,201,197,85,141,28,81,7,177,196,5,79,54,130,39,179,156,124,2,32,124,204,4,111,219,181,95,241,236,122,168,134,150,202,149,9,172,3,60,158,12,15,30,69,116,236,192,185,247,140,238,10]}},{"uuid":"8cc577ef-954f-440a-8329-4d244cae6cdb","publicKey":{"type":"Buffer","data":[4,60,173,198,187,52,232,6,51,60,89,161,120,251,71,239,156,72,43,216,110,237,221,186,15,83,113,177,110,38,204,210,147,137,127,109,164,220,28,18,43,130,245,19,38,119,175,62,120,61,77,33,209,198,135,12,243,193,190,42,76,65,88,219,73]},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","offerAsset":"native","offerAmount":200,"requestAsset":"peanuts","requestAmount":95,"conditions":[],"juryPool":"ghi1234","challengeStake":5,"audience":[],"takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","message":"countered","previousHash":{"type":"Buffer","data":[6,93,208,121,252,179,154,65,17,239,85,200,23,221,98,195,8,71,41,248,229,170,166,21,218,125,192,2,120,53,192,200]}},"recipientKey":{"type":"Buffer","data":[4,125,163,195,169,239,252,211,66,233,105,52,198,59,236,234,24,82,197,194,41,111,204,250,254,178,0,134,47,251,156,223,44,164,5,175,57,189,6,239,17,130,125,226,38,233,166,209,74,188,142,194,230,230,225,98,65,29,132,211,67,97,168,139,216]},"hash":{"type":"Buffer","data":[31,185,67,223,12,132,81,46,108,140,8,54,230,32,15,123,198,95,221,218,133,84,247,235,90,204,240,171,236,98,11,161]},"signature":{"type":"Buffer","data":[48,69,2,33,0,142,245,210,49,188,60,51,182,115,36,248,77,148,91,16,31,234,245,225,141,120,127,89,220,101,144,244,53,114,110,201,97,2,32,25,199,68,84,153,107,164,47,175,57,156,165,205,188,161,16,91,233,55,195,249,67,94,40,42,37,130,25,108,86,222,148]}}],"acceptances":[{"uuid":"10c7f004-03c6-447f-8ed3-e49a3c8cad17","publicKey":{"type":"Buffer","data":[4,125,163,195,169,239,252,211,66,233,105,52,198,59,236,234,24,82,197,194,41,111,204,250,254,178,0,134,47,251,156,223,44,164,5,175,57,189,6,239,17,130,125,226,38,233,166,209,74,188,142,194,230,230,225,98,65,29,132,211,67,97,168,139,216]},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","offerAsset":"native","offerAmount":200,"requestAsset":"peanuts","requestAmount":95,"conditions":[],"juryPool":"ghi1234","challengeStake":5,"audience":[],"takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","message":"accepted","previousHash":{"type":"Buffer","data":[31,185,67,223,12,132,81,46,108,140,8,54,230,32,15,123,198,95,221,218,133,84,247,235,90,204,240,171,236,98,11,161]}},"recipientKey":{"type":"Buffer","data":[4,60,173,198,187,52,232,6,51,60,89,161,120,251,71,239,156,72,43,216,110,237,221,186,15,83,113,177,110,38,204,210,147,137,127,109,164,220,28,18,43,130,245,19,38,119,175,62,120,61,77,33,209,198,135,12,243,193,190,42,76,65,88,219,73]},"hash":{"type":"Buffer","data":[64,76,234,200,237,236,90,171,171,88,218,219,133,112,119,244,187,0,229,223,241,179,0,205,28,168,100,101,220,54,14,195]},"signature":{"type":"Buffer","data":[48,68,2,32,114,41,24,229,210,230,150,98,12,210,121,183,229,155,234,118,120,197,78,213,162,78,241,82,39,4,77,52,195,85,239,105,2,32,63,184,10,51,110,54,0,143,254,14,212,156,8,254,95,66,82,144,162,171,29,220,154,152,63,180,117,195,246,112,85,255]}}],"fulfillments":[{"uuid":"4b643877-e2e3-46f1-b011-bf00ce6b5b28","publicKey":{"type":"Buffer","data":[4,125,163,195,169,239,252,211,66,233,105,52,198,59,236,234,24,82,197,194,41,111,204,250,254,178,0,134,47,251,156,223,44,164,5,175,57,189,6,239,17,130,125,226,38,233,166,209,74,188,142,194,230,230,225,98,65,29,132,211,67,97,168,139,216]},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","message":"fulfillment","fulfillment":"account transfer","previousHash":{"type":"Buffer","data":[64,76,234,200,237,236,90,171,171,88,218,219,133,112,119,244,187,0,229,223,241,179,0,205,28,168,100,101,220,54,14,195]}},"recipientKey":{"type":"Buffer","data":[4,60,173,198,187,52,232,6,51,60,89,161,120,251,71,239,156,72,43,216,110,237,221,186,15,83,113,177,110,38,204,210,147,137,127,109,164,220,28,18,43,130,245,19,38,119,175,62,120,61,77,33,209,198,135,12,243,193,190,42,76,65,88,219,73]},"hash":{"type":"Buffer","data":[67,223,25,23,58,210,187,40,9,250,209,193,188,85,199,235,65,39,124,140,190,105,152,36,123,8,203,224,145,249,9,29]},"signature":{"type":"Buffer","data":[48,68,2,32,62,201,128,149,246,73,82,150,172,123,19,255,104,116,152,43,107,85,211,35,6,71,117,7,202,35,73,212,191,100,18,92,2,32,31,85,182,7,234,147,34,196,149,163,186,22,159,232,103,127,170,5,243,3,107,90,161,211,231,198,132,65,6,244,48,188]}}],"resolution":{"uuid":"9f0b13c8-0e27-41a4-9323-d12f274a9afa","publicKey":{"type":"Buffer","data":[4,60,173,198,187,52,232,6,51,60,89,161,120,251,71,239,156,72,43,216,110,237,221,186,15,83,113,177,110,38,204,210,147,137,127,109,164,220,28,18,43,130,245,19,38,119,175,62,120,61,77,33,209,198,135,12,243,193,190,42,76,65,88,219,73]},"body":{"requestId":"cde1234","makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","message":"resolved","previousHash":{"type":"Buffer","data":[169,121,127,185,226,16,85,133,214,24,166,106,173,48,218,41,59,25,126,143,195,187,213,171,124,83,233,115,7,227,74,13]}},"hash":{"type":"Buffer","data":[36,228,137,174,27,122,97,180,39,26,56,55,115,217,235,108,128,102,105,205,170,124,82,9,220,49,61,142,48,232,44,206]},"signature":{"type":"Buffer","data":[48,69,2,33,0,216,131,136,91,52,129,54,234,64,179,32,132,245,196,92,153,83,214,65,213,72,187,156,187,52,86,171,72,62,10,114,167,2,32,42,47,3,98,235,115,217,57,41,80,242,142,189,174,234,122,24,209,92,74,94,191,12,177,151,160,217,82,134,238,109,116]}},"settlementInitiated":{"uuid":"c4740783-79bc-4248-8619-8561f84779b4","publicKey":{"type":"Buffer","data":[4,60,173,198,187,52,232,6,51,60,89,161,120,251,71,239,156,72,43,216,110,237,221,186,15,83,113,177,110,38,204,210,147,137,127,109,164,220,28,18,43,130,245,19,38,119,175,62,120,61,77,33,209,198,135,12,243,193,190,42,76,65,88,219,73]},"body":{"makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","requestId":"cde1234","message":"settlementInitiated","escrow":"GCT7PLEIPSATD5TRKAZHCON3MJIEMPP6BWUETX773WNBWPLHRFE5HMMB","previousHash":{"type":"Buffer","data":[64,76,234,200,237,236,90,171,171,88,218,219,133,112,119,244,187,0,229,223,241,179,0,205,28,168,100,101,220,54,14,195]}},"recipientKey":{"type":"Buffer","data":[4,125,163,195,169,239,252,211,66,233,105,52,198,59,236,234,24,82,197,194,41,111,204,250,254,178,0,134,47,251,156,223,44,164,5,175,57,189,6,239,17,130,125,226,38,233,166,209,74,188,142,194,230,230,225,98,65,29,132,211,67,97,168,139,216]},"hash":{"type":"Buffer","data":[249,127,202,225,61,26,244,101,163,210,129,201,232,21,108,196,52,103,91,55,76,171,156,61,114,111,26,71,8,205,13,73]},"signature":{"type":"Buffer","data":[48,69,2,33,0,178,66,3,33,63,174,26,20,94,43,253,56,150,149,171,135,221,77,84,191,145,124,108,78,8,178,133,61,59,205,79,86,2,32,102,223,225,208,147,111,232,250,86,31,191,54,97,186,6,234,193,116,254,8,230,135,143,101,182,26,14,97,245,66,184,55]}},"signatureRequired":{"uuid":"7281b0a7-a85f-49ca-9eed-67dfa2baae44","publicKey":{"type":"Buffer","data":[4,60,173,198,187,52,232,6,51,60,89,161,120,251,71,239,156,72,43,216,110,237,221,186,15,83,113,177,110,38,204,210,147,137,127,109,164,220,28,18,43,130,245,19,38,119,175,62,120,61,77,33,209,198,135,12,243,193,190,42,76,65,88,219,73]},"body":{"makerId":"GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3","takerId":"GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV","requestId":"cde1234","message":"signatureRequired","transaction":"AAAAAKf3rIh8gTH2cVAycTm7YlBGPf4NqEnf/92aGz1niUnTAAAAyAAUSeUAAAACAAAAAAAAAAAAAAACAAAAAAAAAAEAAAAAYo4h6Lq9uidCXGzXtEYZObEB6M9DurLG2zg4Itl8YAMAAAAAAAAAAHc1lAAAAAAAAAAACAAAAAAYJf2teKEI0fmZRSwam/E+esu7RaxyvOw49ePdCSKUxgAAAAAAAAABCSKUxgAAAEBNKReXbtrLWvYYq0HtT8WiqWenb2IuMuGIDbisj9O2K3MJNQfuXzJ3ifIL+yJbEDlRQ/iUgWXQfzKSNB1GD9EJ","previousHash":{"type":"Buffer","data":[64,76,234,200,237,236,90,171,171,88,218,219,133,112,119,244,187,0,229,223,241,179,0,205,28,168,100,101,220,54,14,195]}},"recipientKey":{"type":"Buffer","data":[4,125,163,195,169,239,252,211,66,233,105,52,198,59,236,234,24,82,197,194,41,111,204,250,254,178,0,134,47,251,156,223,44,164,5,175,57,189,6,239,17,130,125,226,38,233,166,209,74,188,142,194,230,230,225,98,65,29,132,211,67,97,168,139,216]},"hash":{"type":"Buffer","data":[175,107,189,155,103,108,111,4,253,29,153,132,13,72,7,176,88,100,24,185,75,23,128,223,224,22,31,136,26,184,200,154]},"signature":{"type":"Buffer","data":[48,68,2,32,49,253,92,58,65,26,82,130,234,134,243,162,226,75,220,140,238,84,176,129,161,75,102,126,108,87,233,90,175,22,46,63,2,32,3,190,202,110,44,1,175,41,70,30,149,242,227,31,25,66,193,167,2,38,55,251,141,232,179,146,249,209,78,134,248,188]}}}]] '

const proposals = new Map(JSON.parse(proposalsJson))

test('build agreement does', () => {
    //Assemble

    //Action
    const agreement = buildAgreement(proposals.get('cde1234'))

    //Assert
    //let keyBuffer = Buffer.from(agreement.publicKey.data)
    console.log(keyBuffer.toString())
    //expect(agreement.publicKey.data.toString()).toEqual('walrus')
    expect(agreement.body.message).toEqual('proposal')
    expect(agreement.body.makerId).toEqual('GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3')
    expect(agreement.body.offerAsset).toEqual('native')
    expect(agreement.body.offerAmount).toEqual(200)
    expect(agreement.body.requestAsset).toEqual('peanuts')
    expect(agreement.body.requestAmount).toEqual(100)

    const firstCounterOffer = agreement.next
    expect(firstCounterOffer.body.message).toEqual('countered')
    expect(firstCounterOffer.body.makerId).toEqual('GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3')
    expect(firstCounterOffer.body.takerId).toEqual('GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV')
    expect(firstCounterOffer.body.offerAsset).toEqual('native')
    expect(firstCounterOffer.body.offerAmount).toEqual(200)
    expect(firstCounterOffer.body.requestAsset).toEqual('peanuts')
    expect(firstCounterOffer.body.requestAmount).toEqual(80)

    const secondCounterOffer = agreement.next.next
    expect(secondCounterOffer.body.message).toEqual('countered')
    expect(secondCounterOffer.body.makerId).toEqual('GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3')
    expect(secondCounterOffer.body.takerId).toEqual('GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV')
    expect(secondCounterOffer.body.offerAsset).toEqual('native')
    expect(secondCounterOffer.body.offerAmount).toEqual(200)
    expect(secondCounterOffer.body.requestAsset).toEqual('peanuts')
    expect(secondCounterOffer.body.requestAmount).toEqual(95)

    const acceptance = agreement.next.next.next
    expect(acceptance.body.message).toEqual('accepted')
    expect(acceptance.body.makerId).toEqual('GAMCL7NNPCQQRUPZTFCSYGU36E7HVS53IWWHFPHMHD26HXIJEKKMM7Y3')
    expect(acceptance.body.takerId).toEqual('GBRI4IPIXK63UJ2CLRWNPNCGDE43CAPIZ5B3VMWG3M4DQIWZPRQAGAHV')
    expect(acceptance.body.offerAsset).toEqual('native')
    expect(acceptance.body.offerAmount).toEqual(200)
    expect(acceptance.body.requestAsset).toEqual('peanuts')
    expect(acceptance.body.requestAmount).toEqual(95)
    /*
    console.log('original proposal *******')
    console.log('offerAsset: ' + agreement.body.offerAsset)
    console.log('offerAmount: ' + agreement.body.offerAmount)
    console.log('requestAsset: ' + agreement.body.requestAsset)
    console.log('requestAmount: ' + agreement.body.requestAmount)
    let message = agreement
    do {
        message = message.next
        console.log(message.body.message + ' *******')
        console.log('offerAsset: ' + message.body.offerAsset)
        console.log('offerAmount: ' + message.body.offerAmount)
        console.log('requestAsset: ' + message.body.requestAsset)
        console.log('requestAmount: ' + message.body.requestAmount)
    } while (message.next)
    */
})